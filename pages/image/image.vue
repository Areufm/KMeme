<template>
	<view class="image-container">

		<!-- ================== 页面顶部内容 ================== -->

		<!-- 顶部状态栏：占位 -->
		<up-status-bar></up-status-bar>
		<!-- 顶部导航栏 -->
		<up-navbar
		  :border="false"
		  :bg-color="BarBg"
		  title="我的收藏"
		  :title-style="titleStyle"
		  :left-icon-color="leftIconColor"
		  @leftClick="goBack"
		>
		</up-navbar>

		<!-- ================== 页面主体内容：支持纵向滚动 ================== -->

		<scroll-view
			class="content"
			scroll-y
			:scroll-top="scrollTop"
			@scroll="handleScroll"
			ref="contentRef"
		>

			<!-- 统计信息栏 -->
			<view class="stats-section">
			    <view class="stats-card">
					<view class="stats-number">{{ searchResults.length }}</view>
					<view class="stats-label">收藏图片</view>
			    </view>
			    <view class="stats-card">
					<view class="stats-number">{{ getCollectedAlbums() }}</view>
					<view class="stats-label">相册数量</view>
			    </view>
			    <view class="stats-card">
					<view class="stats-number">{{ getTotalTags() }}</view>
					<view class="stats-label">标签种类</view>
			    </view>
			</view>

			<!-- 搜索筛选栏 -->
			<view class="filter-section">
				<!-- 搜索栏，点击进行搜索操作 -->
				<view class="search-header">
					<up-search
						placeholder="请输入关键词搜索..."
						bg-color="rgba(255,255,255,0.9)"
						v-model="keyword"
						:show-action="true"
						actionText="搜索"
						shape="square"
						height="20"
						:animation="true"
						@search="handleSearch"
						@clear="handleClear"
					></up-search>
				</view>
				<view class="filter-title">
					<up-icon name="funnel" size="18" :color="iconColors?.funnel || '#333'"></up-icon>
					<text>筛选标签</text>
				</view>
				<!-- 标签列表区域 -->
				<view
				  class="filter-tags"
				  :class="{ collapsed: !showAllTags }"
				>
					<view
					    class="filter-tag"
					    :class="{ active: currentFilter === 'all' }"
					    @tap="setFilter('all')"
					>
					    全部
					</view>
					<view
						v-for="tag in availableFilters"
						:key="tag"
						class="filter-tag"
						:class="{ active: currentFilter === tag }"
						@tap="setFilter(tag)"
					>
					    {{ tag }}
					</view>
			    </view>
				<!-- 展开 / 收起 按钮 -->
				<view class="toggle-btn" @tap="toggleShowTags">
				  <text>{{ showAllTags ? '→ 收起 ←' : '← 展开更多 →' }}</text>
				</view>
			</view>


			<!-- 搜索结果标题 -->
			<view class="section-title">
			    <text class="title-text">我的收藏</text>
			    <view class="title-line"></view>
			</view>

			<!-- 收藏图片区域 -->
			<view class="search-results-container">
				<!-- 收藏图片不为空 -->
				<template v-if="filteredList.length > 0">
					<view class="album-list">
						<view
							v-for="(item, index) in filteredList"
							:key="item.imgId"
							class="album-item"
							:style="{ animationDelay: index * 0.05 + 's' }"
						>
							<!-- 相册封面图 -->
							<view class="album-image-container">
								<!-- 图片预览 -->
								<view @tap="previewImage(filteredList, index)">
									<!-- 图片懒加载 -->
									<up-lazy-load threshold="-450" border-radius="10" :image="item.imgUrl" :index="index"></up-lazy-load>
									<!-- 图片悬浮图标 -->
									<view class="album-overlay">
										<up-icon name="heart-fill" size="20" color="#ef4444"></up-icon>
									</view>
								</view>
							</view>
							<!-- 相册标题和标签 -->
							<view class="album-info">
								<text class="album-title">{{ item.title }}</text>
								<view class="album-meta">
									<!-- 标签 -->
									<view class="album-tag">
										<up-icon name="tag" size="12" color="#8b5cf6"></up-icon>
										<text>{{ Array.isArray(item.tag) ? item.tag.join(', ') : item.tag }}</text>
									</view>
									<!-- 收藏状态 -->
									<view class="album-stats">
										<up-icon name="heart-fill" size="12" color="#ef4444"></up-icon>
										<text>已收藏</text>
									</view>
								</view>
							</view>
						</view>
					</view>
				</template>
				<!-- 收藏为空 -->
				<template v-else>
					<up-empty
						mode="list"
						icon="https://placehold.co/600x400/EEEEEE/999999/png?text=No+Collection"
						text="还没有收藏任何图片"
					></up-empty>
				</template>
			</view>
		</scroll-view>

		<!-- ================== 页面其他内容 ================== -->

		<!-- 置顶按钮，滚动超过阈值时显示 -->
		<view v-if="showTopBtn" @click="toTop" class="topClass">
			<up-icon name="arrow-upward" :color="topBtnIconColor" size="28"></up-icon>
		</view>

	</view>
</template>

<script setup>
/* ===================== 依赖导入 ===================== */
import { onLoad } from '@dcloudio/uni-app';
import { computed, ref, watch } from 'vue';
import { collectList } from '../../api/api.js';

/* ===================== 响应式数据定义 ===================== */
// scroll-view 引用
const contentRef = ref(null);
// scroll-view 位置控制
const scrollTop = ref(0);

// 界面样式配置
// 状态栏背景色
const BarBg = '#5e2ec0'
// 标题样式
const titleStyle = { color: "#fff", fontWeight: "bold" };
// 左侧图标颜色
const leftIconColor = "#fff";
const iconColors = {
  funnel: "#6366f1",
  heartFill: "#ef4444",
  share: "#6366f1",
};

// 搜索关键词
const keyword = ref('');
// 搜索结果列表（现在是收藏列表）
const searchResults = ref([]);
// 当前筛选条件
const currentFilter = ref('all');
// 过滤标签展开
const showAllTags = ref(false);

// 是否显示置顶按钮（0不显示，1显示）
const showTopBtn = ref(0);
// 置顶按钮图标颜色
const topBtnIconColor = "#ffffff";

/* ===================== 生命周期 ===================== */
// 页面加载时初始化数据
onLoad((options) => {
	// 加载收藏数据
	fetchCollectedImages();
});

/* ===================== 方法定义 ===================== */

/**
 * 过滤标签展开函数
 */
const toggleShowTags = () => {
  showAllTags.value = !showAllTags.value;
};

/**
 * 标签函数
 * 获取可用的筛选标签
 */
const availableFilters = computed(() => {
    const tags = new Set();
    searchResults.value.forEach((item) => {
		item.tag.forEach((tag) => tags.add(tag));
    });
    return Array.from(tags);
});

/**
 * 标签列表函数
 * 筛选后的列表
 */
const filteredList = computed(() => {
  if (currentFilter.value === "all") {
    return searchResults.value;
  }
  return searchResults.value.filter((item) =>
    item.tag.includes(currentFilter.value)
  );
});

/**
 * 设置筛选器
 */
const setFilter = (filter) => {
	currentFilter.value = filter;
};

/**
 * 相册数量函数
 * 获取收藏的相册数量
 */
const getCollectedAlbums = () => {
  const albums = new Set();
  searchResults.value.forEach((item) => {
    item.tag.forEach((tag) => albums.add(tag));
  });
  return albums.size;
};

/**
 * 标签总数函数
 * 获取标签总数
 */
const getTotalTags = () => {
  return availableFilters.value.length;
};

/**
 * 图片预览函数
 */
const previewImage = (list, index) => {
	// 将响应式数组转为普通数组
    const rawList = Array.isArray(list) ? [...list] : []; // 解包 proxy
    const urls = rawList.map(item => item.imgUrl);
	console.log('图片预览处理:', urls);
    uni.previewImage({
		urls,
		current: urls[index],
		fail: (err) => {
			console.error('预览失败:', err)
			uni.showToast({ title: '预览失败', icon: 'none' })
		}
	})
}

/**
 * 加载收藏图片数据
 */
const fetchCollectedImages = () => {
    uni.showLoading({ title: '加载中...' });
    collectList().then(res => {
        searchResults.value = res || [];
        console.log('收藏图片数据:', searchResults.value);
    }).catch(err => {
        console.error('收藏图片加载失败:', err);
        uni.showToast({ title: '加载失败', icon: 'none' });
    }).finally(() => {
        uni.hideLoading();
    });
};

/**
 * 监听关键词变化
 */
watch(keyword, (val) => {
	console.log('关键词变化:', val);
});

// 防抖搜索
let searchTimeout = null;
/**
 * 处理搜索逻辑
 */
const handleSearch = () => {
	if (searchTimeout) clearTimeout(searchTimeout);

	searchTimeout = setTimeout(() => {
		const trimmedKeyword = keyword.value.trim();
		if (!trimmedKeyword) {
			uni.showToast({ title: '请输入关键词', icon: 'none' });
			return;
		}

		// 在已收藏的图片中搜索
		const filtered = searchResults.value.filter(item => {
			const inTitle = item.title.toLowerCase().includes(trimmedKeyword.toLowerCase());
			const inTags = item.tag.some(t => t.toLowerCase().includes(trimmedKeyword.toLowerCase()));
			return inTitle || inTags;
		});

		// 创建临时结果显示
		uni.showToast({
			title: `找到${filtered.length}个结果`,
			icon: filtered.length > 0 ? 'success' : 'none'
		});
	}, 300);
};

// 节流处理
let clearDebounceTimeout  = null;
/**
 * 清空搜索结果，恢复原始数据
 */
const handleClear = () => {
    if (clearDebounceTimeout ) clearTimeout(clearDebounceTimeout );
	clearDebounceTimeout  = setTimeout(() => {
		fetchCollectedImages(); // 重新加载收藏数据
		uni.showToast({ title: '已清空搜索', icon: 'none' });
		clearDebounceTimeout = null;
	}, 200);
};

/**
 * 监听 scroll-view 滚动事件，控制置顶按钮显示与隐藏
 * @param {Object} e - 滚动事件对象
 */
const handleScroll = (e) => {
    const top = e.detail?.scrollTop ?? 0;
    showTopBtn.value = top > 600 ? 1 : 0;
};

/**
 * 置顶按钮点击事件，回到顶部
 * 说明：
 * - scroll-view 使用 scrollTop 属性控制滚动
 * - 设置 scrollTop 为当前值无效，故先赋值为 1 再归零，模拟滚动
 * - 该方案无滚动动画效果，原生小程序 pageScrollTo 可平滑滚动，但不可用于非全页面滚动
 */
const toTop = () => {
    scrollTop.value = 1; // 先赋非0值避免无效
    setTimeout(() => {
        scrollTop.value = 0; // 再回到顶部
    }, 150);
};

/**
 * 返回首页（底部标签页切换）
 */
const goBack = () => {
    uni.switchTab({
        url: "/pages/index/index",
    });
};
</script>

<style lang="scss" scoped>
// 页面容器样式
.image-container {
	min-height: 100vh;
}

.content {
	position: absolute;
	top: 150rpx;
	left: 0;
	right: 0;
	bottom: 0;
	padding-top: 20rpx;
}

// 统计信息
.stats-section {
	display: flex;
	justify-content: space-between;
	margin: 20rpx;
	gap: 20rpx;

	.stats-card {
		flex: 1;
		background-color: #fff;
		border-radius: 24rpx;
		box-shadow: 0 6rpx 18rpx rgba(0, 0, 0, 0.05);
		padding: 30rpx 20rpx;
		text-align: center;
		transition: transform 0.2s;

		&:hover {
			transform: translateY(-6rpx);
		}

		.stats-number {
			font-size: 40rpx;
			font-weight: bold;
			color: #007aff;
			margin-bottom: 10rpx;
		}

		.stats-label {
			font-size: 24rpx;
			color: #666;
		}
	}
}

// 搜索筛选区域
.search-header {
	position: fix;
	top: 20rpx;
	z-index: 10;
	margin-bottom: 20rpx;
	padding: 20rpx;
	background: rgba(255, 255, 255, 0.9);
	border-radius: 20rpx;
	box-shadow: 0 8rpx 20rpx rgba(0, 0, 0, 0.08);
	backdrop-filter: blur(10px);
}

.filter-section {
	background: rgba(255, 255, 255, 0.95);
	border-radius: 16rpx;
	padding: 30rpx;
	margin-bottom: 10rpx;
	backdrop-filter: blur(10px);
	box-shadow: 0 4rpx 20rpx rgba(0, 0, 0, 0.1);

	.filter-title {
		display: flex;
		align-items: center;
		gap: 12rpx;
		margin-bottom: 20rpx;
		font-size: 28rpx;
		font-weight: bold;
		color: #1f2937;
	}

	.filter-tags {
		display: flex;
		flex-wrap: wrap;
		gap: 16rpx;

		&.collapsed {
		    max-height: 60rpx; // 控制默认只显示一行
		    overflow: hidden;
		  }

		.filter-tag {
			padding: 12rpx 24rpx;
			background: #f1f5f9;
			border: 2rpx solid #e2e8f0;
			border-radius: 50rpx;
			font-size: 24rpx;
			color: #64748b;
			transition: all 0.2s ease;

			&.active {
				background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
				border-color: #6366f1;
				color: #fff;
			}
			&:active {
				transform: scale(0.95);
			}
		}
	}

	.toggle-btn {
	  margin-top: 10rpx;
	  font-size: 24rpx;
	  color: #888;
	  text-align: left;
	}
}

// 搜索结果标题
.section-title {
	display: flex;
	align-items: center;
	margin: 10rpx 20rpx;

	.title-text {
		font-size: 32rpx;
		font-weight: bold;
		color: #fff;
		margin-right: 20rpx;
	}

	.title-line {
		flex: 1;
		height: 2rpx;
		background: linear-gradient(
			90deg,
			rgba(255, 255, 255, 0.5) 0%,
			transparent 100%
		);
	}
}

// 搜索结果区域
.search-results-container {
	flex: 1; // 填充剩余空间
	padding: 10rpx;
	overflow-y: auto; // 允许内容滚动

	// 相册列表样式 (与首页相册列表样式保持一致，或根据需要调整)
	.album-list {
		display: flex;
		flex-wrap: wrap;
		justify-content: space-between;
		gap: 10rpx;

		// 相册卡片项
		.album-item {
			width: calc(50% - 10rpx);
			background: #fff;
			border-radius: 16rpx;
			overflow: hidden;
			box-shadow: 0 4rpx 20rpx rgba(0, 0, 0, 0.08);
			transition: all 0.3s ease;
			animation: fadeInUp 0.6s ease forwards;
			opacity: 0;
			transform: translateY(30rpx);

			&:active {
				transform: scale(0.98) translateY(30rpx);
			}

			// 图片容器
			.album-image-container {
				position: relative;
				height: 240rpx;
				overflow: hidden;

				.album-overlay {
					position: absolute;
					top: 0;
					left: 0;
					right: 0;
					bottom: 0;
					background: rgba(0, 0, 0, 0.3);
					display: flex;
					align-items: center;
					justify-content: center;
					opacity: 0;
					transition: opacity 0.3s ease;
				}

				&:hover .album-overlay {
					opacity: 1;
				}
			}

			// 文本信息
			.album-info {
				padding: 24rpx;

				.album-title {
					font-size: 28rpx;
					font-weight: 600;
					color: #1f2937;
					margin-bottom: 12rpx;
					display: block;
					overflow: hidden;
					text-overflow: ellipsis;
					white-space: nowrap;
				}

				.album-meta {
					display: flex;
					justify-content: space-between;
					align-items: center;

					.album-tag {
						display: flex;
						align-items: center;
						gap: 8rpx;
						font-size: 22rpx;
						color: #8b5cf6;
					}

					.album-stats {
						display: flex;
						align-items: center;
						gap: 6rpx;
						font-size: 22rpx;
						color: #6b7280;
					}
				}
			}
		}
	}
}

// 动画效果
@keyframes fadeInUp {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
